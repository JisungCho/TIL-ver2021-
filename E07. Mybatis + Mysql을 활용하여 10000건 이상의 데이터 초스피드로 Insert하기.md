# E07. Mybatis + Mysql을 활용하여 10000건 이상의 데이터 초스피드로 Insert하기

## 1. pom.xml에 commons-lang3 라이브러리 추가

- Commons-Lang은 java.lang에 있는 클래스처럼 기능적으로 필요한 유틸리티들을 모아놓은 클래스들의 집합

  ```XML
  		<!-- https://mvnrepository.com/artifact/org.apache.commons/commons-lang3 -->
  		<dependency>
  			<groupId>org.apache.commons</groupId>
  			<artifactId>commons-lang3</artifactId>
  		</dependency>
  ```

## 2. applicaion.properties jdbcUrl 옵션 추가

- MySQL JDBC는 기본적으로 하나의 SQL 실행 요청에 여러 SQL을 실행하는 것을 금지하고 있다.(세미콜론(;)으로 여러 SQL 전송 불가)
- 실서비스에서는 사용하지 말고, 테스트시에 필요한 경우 `allowMultiQueries`로 허용 가능하다.
- `allowMultiQueries=true`

```properties
datasource.jdbc-url=jdbc:log4jdbc:mysql://localhost:3306/test1?allowMultiQueries=true&serverTimezone=UTC&characterEncoding=UTF-8
```

## 3. logback-default.xml root level 수정

```xml
	<root level="DEBUG">
		<appender-ref ref="STDOUT" />
	</root>
```

## 4. Board.xml에 saveList 쿼리 추가

```xml
	<insert id="saveList" parameterType="map">
		INSERT INTO T_BOARD
		(
			TITLE,
			CONTENTS,
			REG_DATE
		)
		VALUES
		<!--여기서 boardList는 map에 담겨져있는 key 이름 -->
		<foreach collection="boardList" item="board" separator=",">
		(
			#{board.title},
			#{board.contents},
			NOW()
		)
		</foreach>
	</insert>
```

## 5. BoardParameter 생성자 추가

```java
package kr.co.jisung.mvc.parameter;

import java.sql.Date;

import lombok.Data;

//파라미터와 Response는 클래스로 구별하는게 좋다
//getter , setter
@Data
public class BoardParameter {
	private int boardSeq;
	private String title;
	private String contents;
	
	//기본 생성자
	public BoardParameter() {

	}

	public BoardParameter(String title, String contents) {
		this.title = title;
		this.contents = contents;
	}
	
	
}

```



## 6. BoardRepository에 saveList 관련 기능 추가

```java
void save(BoardParameter board);
```



## 7. BoardController , BoardService  saveList1 , saveList2 

```java
	//단순 반복문을 이용한 등록 처리
	public void saveList1(List<BoardParameter> list) {
		for(BoardParameter parameter : list) {
			//반복문이 돌때마다 DB커넥션이 발생
			repository.save(parameter);
		}
	}
	
	// 배열에 담아서 일괄 등록 처리
	public void saveList2(List<BoardParameter> boardList) {
		Map<String, Object> paramMap = new HashMap<>();
		paramMap.put("boardList", boardList);
		//한번의 DB커넥션
		repository.saveList(paramMap);
	}
```

```java
/*
	 * 대용량 등록 처리
	 */
	@PutMapping("/saveList1")
	@ApiOperation(value = "대용량 등록처리1", notes = "대용량 등록처리1")
	public BaseResponse<Boolean> saveList1(){
		int count = 0;
		// 테스트를 위한 랜덤 5000건의 데이터를 생성
		List<BoardParameter> list = new ArrayList<>();
		while(true) {
			count++;
			String title = RandomStringUtils.randomAlphabetic(10);
			String contents = RandomStringUtils.randomAlphabetic(10);
			list.add(new BoardParameter(title, contents));
			if(count >= 5000) {
				break;
			}
		}
		long start = System.currentTimeMillis();
		boardService.saveList1(list);
		long end = System.currentTimeMillis();
		logger.info("실행 시간 : {}", (end - start) / 1000.0);
		return new BaseResponse<Boolean>(true);
	}
	
	/*
	 * 대용량 등록 처리
	 */
	@PutMapping("/saveList2")
	@ApiOperation(value = "대용량 등록처리2", notes = "대용량 등록처리2")
	public BaseResponse<Boolean> saveList2(){
		int count = 0;
		// 테스트를 위한 랜덤 5000건의 데이터를 생성
		List<BoardParameter> list = new ArrayList<>();
		while(true) {
			count++;
			String title = RandomStringUtils.randomAlphabetic(10);
			String contents = RandomStringUtils.randomAlphabetic(10);
			list.add(new BoardParameter(title, contents));
			if(count >= 5000) {
				break;
			}
		}
		long start = System.currentTimeMillis();
		boardService.saveList2(list);
		long end = System.currentTimeMillis();
		logger.info("실행 시간 : {}", (end - start) / 1000.0);
		return new BaseResponse<Boolean>(true);
	}
	
```



## 8.  saveList1 , saveList2 속도 테스트

실행시간 26.59 vs 실행 시간 : 0.561

