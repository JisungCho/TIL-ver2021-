# 2021-06-02

## TodoList

- Filter 적용 시 조건에 맞게 나올 수 있게 설정하기

## SQL 41번부터 48번

### 41. 데이터 분석 함수로 순위 출력하기 (RANK)

- RANK() OVER 다음에 나오는 괄호 안에 출력하고 싶은 데이터를 정렬하는 SQL문장을 넣으면 그 컬럼 값에 대한 데이터의 순위가 출력
- 1등이 두 명인경우 다음 순위는 3등이됨

```sql
-- 월급이 높은 사원부터 순위를 매김 ,
SELECT ename , job , sal , RANK() OVER (ORDER BY sal DESC) as 순위
     FROM emp
     WHERE job IN('ANALYST','MANAGER');

--직업별로 월급이 높은 순서대로 순위를 부여
SELECT ename , job , sal , RANK() OVER (PARTITION BY job ORDER BY sal DESC) as 순위
     FROM emp;
```

### 42. 데이터 분석 함수로 순위 출력하기(DENSE_RANK)

```sql
/*1등이 2명인경우 다음 순위가 3등,  or 2등*/
SELECT ename , job , sal , RANK() OVER (ORDER BY sal DESC) as RANK ,DENSE_RANK() OVER (ORDER BY sal DESC) AS DENSE_RANK
    FROM emp
    WHERE job IN('ANALYST','MANAGER');
  
-- 81년에 입사한 사원들의 직업,이름,월급,순위 출력 , 직업별로 월급이 높은 순서대로 순위를 부여
SELECT job , ename , sal , DENSE_RANK() OVER (PARTITION BY job ORDER BY sal DESC) 순위
    FROM emp
    WHERE hiredate BETWEEN to_date('1981/01/01','RRRR/MM/DD') AND to_date('1981/12/31','RRRR/MM/DD');

--WITHIN GROUP (ORDER BY sal DESC) : 월급이 높은 순서대로 정렬해 놓은 그룹 안에서
--DENSE_RANK(2975) : 월급이 2975의 순위를 출력
SELECT DENSE_RANK(2975) WITHIN GROUP (ORDER BY sal DESC) 순위
    FROM emp;
    
-- 입사일이 낮은순서대로 정렬해 높은 그룹에서 81/11/17 의 순위
SELECT DENSE_RANK('81/11/17') within group(ORDER BY hiredate ASC)
    FROM emp;
```

### 43. 데이터 분석 함수로 등급 출력하기(NTILE)

```sql
--월급을 4등급으로 나눠 출력 , null값은 맨 마지막에 출력
SELECT ename , job , sal , NTILE(4) over (ORDER BY sal DESC nulls last) 등급
    FROM emp
    WHERE job IN ('ANALYST','MANAGER','CLERK');
```

### 44. 데이터 분석 함수로 순위의 비율 출력하기 (CUME_DIST)

```sql
SELECT ename, sal , RANK() OVER (ORDER BY sal desc ) as RANK ,
                    DENSE_RANK() OVER (ORDER BY sal DESC) as DENSE_RANK,
                    CUME_DIST() OVER (ORDER BY sal DESC) as CUM_DIST
    FROM emp;
    
SELECT job ,ename, sal , RANK() OVER (PARTITION BY job ORDER BY sal desc ) as RANK ,
                    CUME_DIST() OVER (PARTITION BY job ORDER BY sal DESC) as CUM_DIST
    FROM emp;
                    
```

### 45. 데이터 분석 함수로 데이터를 가로로 출력하기 (LISTAGG)

```sql
--LISTAGG는 함수는 데이터를 가로로 출력하는 함수
--LISTAGG에 구분자로 콤마를 사용하여 콤마로 구분, 슬래쉬도 사용할 수 있음
-- ename을 정렬한 그룹안에서 ename을 가로로 출력한다
SELECT deptno , LISTAGG(ename , ',') WITHIN GROUP (ORDER BY ename) as EMPLOYEE
    FROM emp
    GROUP BY deptno;

--직업별로 이름을 가로로 출력
SELECT job , LISTAGG(ename, ',') within group (ORDER BY ename ASC) as EMPLOYEE
    FROM emp
    GROUP BY job;
    
--연결 연산자도 같이 사용가능
SELECT job , LISTAGG(ename||'('||sal||')',',') WITHIN GROUP (ORDER BY ename ASC) as EMPLOYEE
     FROM emp
     GROUP BY job;
```

### 46. 데이터 분석 함수로 바로 전 행과 다음 행 출력하기 (LAG , LEAD)

```sql
SELECT empno , ename, sal,
    --바로 전 행의 데이터를 출력 , 1은 바로 전 행 2는 전 전 행
    LAG(sal,1) OVER (order by sal ASC) "전 행",
    --바로 다음 행의 데이터를 출력 , 1은 바로 다음 행 ,2는 다다음행
    LEAD(sal,1) OVER (ORDER BY sal ASC) "다음 행"
FROM emp
WHERE job IN('ANALYST','MANAGER'); 

SELECT empno ,  ename , hiredate,
    LAG(hiredate,1) OVER (ORDER BY hiredate ASC) "전 행",
    LEAD(hiredate,1) OVER (ORDER BY hiredate ASC) "다음 행"
FROM emp
WHERE job IN ('ANALYST' , 'MANAGER');

--부서 번호별로 구분해서 출력
SELECT deptno , empno ,  ename , hiredate,
    LAG(hiredate,1) OVER (PARTITION BY deptno ORDER BY hiredate ASC) "전 행",
    LEAD(hiredate,1) OVER (PARTITION BY deptno ORDER BY hiredate ASC) "다음 행"
FROM emp;


```

### 47. COLUMN을 ROW로 출력하기 (SUM + DECODE)

```SQL
SELECT  SUM(DECODE(deptno,10,sal)) as "10",
        SUM(DECODE(deptno,20,sal)) as "20",
        SUM(DECODE(deptno,30,sal)) as "30"
FROM emp;

--부서 번호가 10이면 월급 출력 아니면 null
SELECT deptno , DECODE(deptno,10,sal) as "10"
    FROM emp;

SELECT SUM(DECODE(deptno,10,sal)) as "10"
    FROM emp;
    
--직업 , 직업별 토탈 월급을 출력
SELECT  SUM(DECODE(job,'ANALYST',sal)) as "ANALYST",
        SUM(DECODE(job,'CLERK',sal)) as "CLERK",
        SUM(DECODE(job,'MANAGER',sal)) as "MANAGER",
        SUM(DECODE(job,'SALESMAN',sal)) as "SALESMAN"
    FROM emp;

-- 부서 번호 별로 각가 직업의 토탈 월급의 분포
SELECT deptno,  SUM(DECODE(job,'ANALYST',sal)) as "ANALYST",
                SUM(DECODE(job,'CLERK',sal)) as "CLERK",
                SUM(DECODE(job,'MANAGER',sal)) as "MANAGER",
                SUM(DECODE(job,'SALESMAN',sal)) as "SALESMAN"
    FROM emp
    GROUP BY deptno;
```

### 38. COLUMN 을 ROW로 출력하기 (PIVOT)

- SUM +DECODE를 PIVOT을 이용해 간단히 작성
- PIVOT문을 사용할 때는 FROM 절에 괄호를 사용해서 특정 칼럼만 선택,
- 반드시 괄호 안에 결과에 필요한 컬럼만 선택하는 쿼리문을 작성

```SQL
--부서 번호와 부서 번호별 토탈 월급을 출력하기 위해 필요한 데이터는 
--부서 번호와 월급 뿐이기 때문에 FROM절에서 부서번호와 월급만 조회
SELECT * FROM ( 
                SELECT deptno , sal FROM emp  )
        PIVOT (SUM(sal) FOR deptno IN (10,20,30));

SELECT *
    FROM (SELECT job , sal FROM emp)
    PIVOT (SUM(sal) for job IN('ANALYST','CLERK','MANAGER','SALESMAN'));
```

