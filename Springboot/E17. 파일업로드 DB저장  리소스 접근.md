# E17. 파일업로드 DB저장 / 리소스 접근

## 정적리소스

- 클라이언트로부터 요청이 들어왔을 때, 요청에 대한 리소스가 이미 만들어져 있어 그대로 응답하는 경우를 뜻함
- 

## T_UPLOAD_FILE 테이블 추가

```mysql
CREATE TABLE `T_UPLOAD_FILE` (
 `UPLOAD_FILE_SEQ` INT(11) NOT NULL AUTO_INCREMENT COMMENT '파일 고유번호',
 `PATHNAME` VARCHAR(100) NOT NULL COMMENT '전체경로' COLLATE 'utf8_general_ci',
 `FILENAME` VARCHAR(50) NOT NULL COMMENT '파일명' COLLATE 'utf8_general_ci',
 `ORIGINAL_FILENAME` VARCHAR(100) NOT NULL COMMENT '원본 파일명' COLLATE 'utf8_general_ci',
 `SIZE` INT(11) NOT NULL COMMENT '파일크기',
 `CONTENT_TYPE` VARCHAR(50) NOT NULL COMMENT '컨텐츠 종류' COLLATE 'utf8_general_ci',
 `RESOURCE_PATHNAME` VARCHAR(100) NOT NULL DEFAULT '' COMMENT '리소스 파일경로' COLLATE 'utf8_general_ci',
 `REG_DATE` DATETIME NOT NULL COMMENT '등록일자',
 PRIMARY KEY (`UPLOAD_FILE_SEQ`) USING BTREE
)
COMMENT='파일'
COLLATE='utf8_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=4
;
```

## UploadFile.xml 작성

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--namespace: Repository 위치 -->
<mapper namespace="kr.co.jisung.mvc.repository.UploadFileRepository">
	<insert id="save" parameterType="kr.co.jisung.mvc.parameter.UploadFileParameter">
			INSERT INTO T_UPLOAD_FILE
			(
				PATHNAME,
				FILENAME,
				ORIGINAL_FILENAME,
				SIZE,
				CONTENT_TYPE,
				RESOURCE_PATHNAME,
				REG_DATE
			)
			VALUE
			(
				#{pathname},
				#{filename},
				#{originalFilename},
				#{size},
				#{contentType},
				#{resourcePathname},
				NOW()
			)
	</insert>
</mapper>
```

## UploadFileParameter 작성

```java
package kr.co.jisung.mvc.parameter;

import lombok.Data;

@Data
public class UploadFileParameter {
	private String pathname;
	private String filename;
	private String originalFilename;
	private int size;
	private String contentType;
	private String resourcePathname;
}

```

## UploadFileRepository 작성

```java
package kr.co.jisung.mvc.repository;

import org.springframework.stereotype.Repository;

import kr.co.jisung.mvc.parameter.UploadFileParameter;

/**
 * 업로드 파일 Repository
 * @author jisun
 *
 */
@Repository
public interface UploadFileRepository {
	void save(UploadFileParameter parameter);
}

```

## UploadFileService 작성

```java
package kr.co.jisung.mvc.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import kr.co.jisung.mvc.parameter.UploadFileParameter;
import kr.co.jisung.mvc.repository.UploadFileRepository;

/**
 * 업로드 파일 서비스
 * @author jisun
 *
 */
@Service
public class UploadFileService {

	@Autowired
	private UploadFileRepository repository;
	
	/*
	 * 등록 처리
	 */
	public void save(UploadFileParameter parameter) {
		repository.save(parameter);
	}
}

```

## global-local.properties에 resourcePath추가

```properties
uploadFile.path = C:/home/upload/
uploadFile.resourcePath = /upload/
scheduler.cron.example1 = */50 * * * * * 
```

## GlobalConfig에 uploadResourcPath 추가

```java
package kr.co.jisung.configuration;

import java.util.Properties;

import javax.annotation.PostConstruct;

import org.apache.commons.lang3.ObjectUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.core.io.support.PropertiesLoaderUtils;

//Properties 파일 읽어옴
public class GlobalConfig {
	Logger logger = LoggerFactory.getLogger(getClass());
	
	@Autowired
	private ApplicationContext context;
	
	//리소스를 읽어오는 기능을 제공
	@Autowired
	private ResourceLoader resourceLoader;
	
	private String uploadFilePath;
	private String schedulerCronExample1;
	//uploadResourcePath 추가
	private String uploadResourcePath;
	
	private boolean local;
	private boolean dev;
	private boolean prod;
	
	//의존성주입이 이루어진 후 초기화를 하는 메서드
	@PostConstruct
	public void init() {
		logger.info("init");
		//현재 active한 프로파일을 가져
		String[] activeProfiles = context.getEnvironment().getActiveProfiles();
		String  activeProfile = "local";
		if(ObjectUtils.isNotEmpty(activeProfiles)) {
			activeProfile = activeProfiles[0];
		}
		String resourcePath = String.format("classpath:globals/global-%s.properties", activeProfile);
		try {
			//properties 정보를 가져옴
			Resource resource =  resourceLoader.getResource(resourcePath);
			Properties properties = PropertiesLoaderUtils.loadProperties(resource);
			this.uploadFilePath = properties.getProperty("uploadFile.path");
			//정적리소스경로 가져오기
			this.uploadResourcePath = properties.getProperty("uploadFile.resourcePath");
			this.schedulerCronExample1 = properties.getProperty("scheduler.cron.example1");
			this.local = activeProfile.equals("local");
			this.dev = activeProfile.equals("dev");
			this.prod = activeProfile.equals("prod");
		} catch (Exception e) {
			logger.error("error");
		}
	}

	public String getUploadFilePath() {
		return uploadFilePath;
	}
	
	public String getUploadResourcePath() {
		return uploadResourcePath;
	}

	public boolean isLocal() {
		return local;
	}

	public boolean isDev() {
		return dev;
	}

	public boolean isProd() {
		return prod;
	}

	public String getSchedulerCronExample1() {
		return schedulerCronExample1;
	}
	
}

```

## WebConfiguration 설정

```java
package kr.co.jisung.configuration;

import java.util.List;
import java.util.Locale;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.http.MediaType;
import org.springframework.web.method.support.HandlerMethodArgumentResolver;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
import org.springframework.web.servlet.view.json.MappingJackson2JsonView;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.module.SimpleModule;

import kr.co.jisung.configuration.servlet.handler.BaseHandlerInterceptor;
import kr.co.jisung.framework.data.web.MySQLPageRequestHandleMethodArgumentResolver;
import kr.co.jisung.mvc.domain.BaseCodeLabelEnum;
/*
 * 다국어 지원 설정 + 인터셉터
 */
@Configuration
public class WebConfiguration implements WebMvcConfigurer {
	
	/*
	 * 메세지 소스를 생성한다.
	 */
	@Bean
	public ReloadableResourceBundleMessageSource messageSource() {
		ReloadableResourceBundleMessageSource source = new ReloadableResourceBundleMessageSource();
		//메세지 프로퍼티 파일의 위치와 이름을 지정
		source.setBasename("classpath:/messages/message");
		//기본 인코딩을 지정
		source.setDefaultEncoding("UTF-8");
		//프로퍼티 파일의 변경을 감지할 시간 간격을 지정
		source.setCacheSeconds(60);
		//기본값
		source.setDefaultLocale(Locale.KOREAN);
		//없는 메세지일 경우 예외를 발생시키는 대신 코드를 기본 메세지로 한다.
		source.setUseCodeAsDefaultMessage(true);
		return source;
	}
	
	/*인터셉터 생성*/
	@Bean
	public BaseHandlerInterceptor baseHandlerInterceptor() {
		return new BaseHandlerInterceptor();
	}
	
	/*인터셉터 등록*/
	@Override
	public void addInterceptors(InterceptorRegistry registry) {
		registry.addInterceptor(baseHandlerInterceptor());
	}
	
	/*
	 * MySQLPageRequestHandleMethodArgumentResolver 등록
	 */
	@Override
	public void addArgumentResolvers(List<HandlerMethodArgumentResolver> resolvers) {
		// 페이지 리졸버 등록
		resolvers.add(new MySQLPageRequestHandleMethodArgumentResolver());
	}
	
	@Bean
	public ObjectMapper objectMapper() {
		ObjectMapper objectMapper = new ObjectMapper();
		SimpleModule simpleModule = new SimpleModule();
		simpleModule.addSerializer(BaseCodeLabelEnum.class, new BaseCodeLabelEnumJsonSerializer());
		objectMapper.registerModule(simpleModule);
		return objectMapper;
	}
	
	//GlobalConfig
	@Bean
	public GlobalConfig config() {
		return new GlobalConfig();
	}
	
	@Bean
	public MappingJackson2JsonView mappingJackson2JsonView() {
		MappingJackson2JsonView jsonView = new MappingJackson2JsonView();
		jsonView.setContentType(MediaType.APPLICATION_JSON_VALUE);
		jsonView.setObjectMapper(objectMapper());
		return jsonView;
	}

	/*
	 * 정적리소스 설정
	 * addResourceHandler() : 매핑 URI 설정
	 * addResourceLocations() : 정적 리소스 위치 설정
	 */
	@Override
	public void addResourceHandlers(ResourceHandlerRegistry registry) {
		// /upload/**
		String resourcePattern = config().getUploadResourcePath() + "**";
		// 로컬(윈도우 한경)
		if(config().isLocal()) {
			//url 를 지정한다. "/upload/**" 로 지정했기 때문에, 
			// http://localhost:8080/upload/파일명 같은 형식으로 접근 할 수 있다
			registry.addResourceHandler(resourcePattern)
			.addResourceLocations("file:///"+config().getUploadFilePath()); //서버에서 제공할 파일들이 있는 폴더를 지정
		}else {
			registry.addResourceHandler(resourcePattern)
			.addResourceLocations("file:"+config().getUploadFilePath());
		}
	}
	
}

```

## FileController 설정

```java
package kr.co.jisung.mvc.controller;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.UUID;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import kr.co.jisung.configuration.GlobalConfig;
import kr.co.jisung.configuration.exception.BaseException;
import kr.co.jisung.configuration.http.BaseResponse;
import kr.co.jisung.configuration.http.BaseResponseCode;
import kr.co.jisung.mvc.parameter.UploadFileParameter;
import kr.co.jisung.mvc.service.UploadFileService;

/*
 * @Api : 해당 클래스가 Swagger리소스라는 것을 명시
 * @ApiOperation : 한 개의 operation을 선언
 * 								VALUE : API에 대한 간략한 설명
 * 								NOTES : 자세한 설명
 * @ApiParam : 파라미터에 대한 정보를 명시합니다.
 * 						value : 파라미터 정보를 작성합니다.
 * 						required : 필수 파라미터이면 true, 아니면 false를 작성합니다.
 * 						example :  테스트를 할 때 보여줄 예시를 작성합니다
*/
@RestController
@RequestMapping("/file")
@Api(tags = "파일 API")
public class FileController {
	Logger logger = LoggerFactory.getLogger(getClass());

	@Autowired
	private GlobalConfig config;

	/*
	 * 파일 업로드 서비스 
	 */
	@Autowired
	private UploadFileService uploadFileService;
	/*
	 * 업로드 리턴
	 */
	@PostMapping("/save")
	@ApiOperation(value = "업로드", notes = "")
	public BaseResponse<Boolean> save(@RequestParam("uploadfile") MultipartFile multipartFile) {
		logger.debug("multipartfile : {}",multipartFile);
		//파일 필수 체크
		if(multipartFile == null || multipartFile.isEmpty()) {
			throw new BaseException(BaseResponseCode.DATA_IS_NULL);
		}
		logger.debug("config : {}", config);
		//날짜폴더를 추가
		//format(현재시간)
		String currentDate = new SimpleDateFormat("yyyMMdd").format(Calendar.getInstance().getTime());
		String uploadFilePath = config.getUploadFilePath()+currentDate+"/";
		logger.debug("uploadFilePath : {}", uploadFilePath);
		
		//확장자 구하기
		String prefix = multipartFile.getOriginalFilename().substring(multipartFile.getOriginalFilename().lastIndexOf(".")+1,multipartFile.getOriginalFilename().length());
		//새로운 파일 이름
		String filename = UUID.randomUUID().toString() +"." +prefix; //파일명 완성
		
		//폴더가 있는지 없는지 확인
		File folder = new File(uploadFilePath);
		//폴더가 없다면
		if(!folder.isDirectory()) {
			folder.mkdirs();
		}
		
		String pathName = uploadFilePath + filename;
		//정적 리소스 주소
		String resourcePathname = config.getUploadResourcePath()+ currentDate+"/"+filename;
		File dest = new File(pathName);
		logger.debug("dest : {}", dest);
		try {
			multipartFile.transferTo(dest);
			//파일업로드 된 후 DB에 저장
			UploadFileParameter parameter = new UploadFileParameter();
			//컨텐츠 종류
			parameter.setContentType(multipartFile.getContentType());
			//원본파일명
			parameter.setOriginalFilename(multipartFile.getOriginalFilename());
			//저장파일명
			parameter.setFilename(filename);
			//실제파일 저장경로
			parameter.setPathname(pathName);
			//파일크기
			parameter.setSize((int)multipartFile.getSize());
			//static resource 접근 경로 , 브라우저에서 접속가능한 static 경로
			parameter.setResourcePathname(resourcePathname);
			uploadFileService.save(parameter);
		
		} catch (IllegalStateException | IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return new BaseResponse<Boolean>(true);
	}
}

```

